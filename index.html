<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GAS Project Manager · Deep Ocean</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2244%22 fill=%22%2308f%22/><circle cx=%2250%22 cy=%2250%22 r=%2226%22 fill=%22%230af%22/></svg>">
<style>
  /* ===== Deep Ocean Theme – design tokens ===== */
  :root{
    --ocean-abyss:#030a14;
    --ocean-deep:#061a2c;
    --ocean-mid:#0b2b43;
    --ocean-light:#0f3b5b;
    --foam:#d9f7ff;
    --text:#eaf2fb;
    --muted:#a0b4c6;

    --primary:#2ad1ff;    /* cyan biolum */
    --accent:#4ff5b6;     /* green biolum */
    --danger:#ff6b81;
    --warn:#ffd166;

    --border:#143149;
    --chip:#0a2236;
    --card:#081c2d;
    --shadow:0 12px 30px rgba(0,0,0,.45);
    --glass:linear-gradient(180deg, rgba(8,28,45,.75), rgba(8,28,45,.55));
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
    background:
      radial-gradient(1600px 800px at 70% -10%, #0c2b49 0%, transparent 60%),
      radial-gradient(1200px 600px at 20% -10%, #083052 0%, transparent 60%),
      var(--ocean-abyss);
    overflow-x:hidden;
  }

  /* Light rays overlay */
  .rays{
    position:fixed; inset:0; pointer-events:none; z-index:0; mix-blend-mode:screen; opacity:.22;
    background:
      conic-gradient(from 190deg at 20% -10%, rgba(80,180,255,.4), transparent 45%),
      conic-gradient(from 200deg at 80% -20%, rgba(80,255,210,.35), transparent 50%);
    filter: blur(12px);
    animation: drift 12s ease-in-out infinite alternate;
  }
  @keyframes drift{
    0%{transform:translateY(-10px) rotate(-1deg)}
    100%{transform:translateY(8px) rotate(1deg)}
  }

  /* Bubbles canvas behind all content */
  canvas#fx{position:fixed;inset:0;z-index:-1;opacity:.55}

  header{
    position:sticky;top:0;z-index:10;
    background:var(--glass);
    backdrop-filter: blur(10px) saturate(1.15);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1240px;margin:0 auto;padding:16px;}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.3px}
  .logo{width:24px;height:24px;border-radius:50%;
    background:
      radial-gradient(10px 10px at 30% 30%, #9effff, transparent 60%),
      conic-gradient(from 180deg at 50% 50%, var(--primary) 0deg, var(--accent) 140deg, #7dd3fc 300deg);
    box-shadow:0 0 16px rgba(74,229,255,.45), inset 0 0 10px rgba(0,0,0,.25);
  }
  .spacer{flex:1}

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--chip);border:1px solid var(--border);color:var(--text);
    padding:8px 10px;border-radius:999px;font-weight:700;font-size:13px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
  }
  .chip input{margin:0}

  .search{
    display:flex;align-items:center;gap:8px;background:var(--ocean-deep);
    border:1px solid var(--border);border-radius:14px;padding:10px 12px;min-width:260px;flex:1;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
  }
  .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:14px}
  .kbd{border:1px solid #2a516c;background:#0a2032;color:#bde9ff;border-radius:6px;padding:2px 6px;font-size:12px}

  .btn, .act{
    position:relative; overflow:hidden;
    background:linear-gradient(135deg, var(--primary), #7dd3fc);
    color:#04121d;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;
    box-shadow:0 8px 22px rgba(37,214,255,.25); transition:transform .12s ease, filter .12s ease;
  }
  .btn:hover, .act:hover{transform:translateY(-1px);filter:brightness(1.05)}
  .btn.secondary{background:#0b2133;color:var(--text);box-shadow:none;border:1px solid var(--border)}
  .btn.warn{background:linear-gradient(135deg, #ffd166, #ffe29a); color:#312300}
  .btn.danger{background:linear-gradient(135deg, #ff6b81, #ff9aa9); color:#2b0710}

  .hero{ padding:16px 0 6px 0; }
  .hero .stats{
    display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px;margin-top:12px
  }
  .stat{
    background:linear-gradient(180deg, rgba(4,18,29,.7), rgba(4,18,29,.4));
    border:1px solid var(--border);border-radius:14px;padding:14px;
    box-shadow:var(--shadow); position:relative;overflow:hidden
  }
  .stat::after{
    content:'';position:absolute;inset:auto -25% -30% -25%;height:3px;
    background:linear-gradient(90deg, var(--primary), #7dd3fc, var(--accent));
    filter:blur(8px);opacity:.8
  }
  .stat .n{font-size:22px;font-weight:900}
  .muted{color:var(--muted)}

  main .wrap{padding-top:12px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-top:16px}
  .card{
    background:linear-gradient(180deg, rgba(8,28,45,.95), rgba(8,28,45,.75));
    border:1px solid var(--border);border-radius:16px;padding:14px;
    box-shadow:var(--shadow);transform:translateZ(0);
    transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, filter .2s ease;
  }
  .card:hover{transform:translateY(-4px) rotateX(1deg) rotateY(-1deg);border-color:#3e89b7;box-shadow:0 16px 36px rgba(0,0,0,.55)}
  .title{font-weight:900;line-height:1.2;word-break:break-word}
  .meta{display:flex;gap:8px;color:var(--muted);font-size:12px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .tag{padding:4px 8px;border-radius:999px;border:1px solid #2a4a62;background:#082033;color:#bfe7ff;font-size:11px}
  .actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
  .act{background:#0c2b43;border:1px solid var(--border);color:#cfefff}
  .act.primary{background:linear-gradient(135deg, var(--primary) 0%, #7dd3fc 100%);color:#052231;border:0}
  .act.warn{background:#132e3f;border:1px solid #20445a;color:#ffeab1}
  .act.danger{background:#331826;border:1px solid #5b2b42;color:#ffc6d0}

  /* Star glow */
  .tag.star{border-color:#34e1ff;background:#062739;color:#bff8ff; box-shadow:0 0 14px rgba(52,225,255,.25) inset}

  /* Water-caustic skeleton */
  .skeleton{
    background:
      radial-gradient(120px 20px at 20% 30%, rgba(60,180,255,.25), transparent 60%),
      radial-gradient(120px 20px at 80% 70%, rgba(80,240,210,.25), transparent 60%),
      linear-gradient(90deg, #0b2335 25%, #133452 37%, #0b2335 63%);
    background-size: 400% 100%;
    animation: shimmer 1.1s ease infinite, sway 6s ease-in-out infinite alternate;
  }
  @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}
  @keyframes sway{0%{transform:translateY(0)}100%{transform:translateY(-2px)}}
  .s-card{height:124px;border-radius:16px;border:1px solid var(--border);padding:14px;background:#092436}
  .s-card .line{height:14px;border-radius:8px}

  .footer{display:flex;justify-content:center;margin:18px 0}

  /* Sonar status bar */
  .statusbar{
    position:fixed;right:16px;bottom:16px;z-index:12;
    background:linear-gradient(180deg, rgba(6,26,44,.9), rgba(6,26,44,.7));
    border:1px solid var(--border);border-radius:14px;padding:10px 12px;display:flex;gap:10px;align-items:center;box-shadow:var(--shadow)
  }
  .dot{position:relative;width:12px;height:12px;border-radius:50%;background:#1e3a4d;border:1px solid #2c5f7f}
  .dot.on::after{
    content:''; position:absolute; inset:-8px; border-radius:50%;
    box-shadow:0 0 0 1px rgba(42,209,255,.55), 0 0 18px rgba(74,229,255,.45);
    animation: sonar 1.5s ease-out infinite;
  }
  @keyframes sonar{0%{transform:scale(.3);opacity:.8}100%{transform:scale(1.6);opacity:0}}

  .toast-wrap{position:fixed;top:14px;right:14px;display:flex;flex-direction:column;gap:8px;z-index:20}
  .toast{
    background:linear-gradient(180deg, rgba(6,26,44,.95), rgba(6,26,44,.75));
    border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);
    transform:translateY(-6px);animation:bubbleIn .22s ease-out forwards;
  }
  @keyframes bubbleIn{to{transform:translateY(0)}}

  /* Ripple click effect (for .btn & .act) */
  .ripple{position:absolute; border-radius:50%; transform:scale(0); pointer-events:none;
          background:radial-gradient(circle, rgba(159,255,255,.9) 0%, rgba(159,255,255,.4) 35%, rgba(159,255,255,0) 70%);
          opacity:.7; animation:ripple .6s ease-out forwards;}
  @keyframes ripple{to{transform:scale(8); opacity:0}}

  @media (max-width:900px){ .hero .stats{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:520px){ .hero .stats{grid-template-columns:1fr} .actions{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<div class="rays"></div>
<canvas id="fx"></canvas>

<header>
  <div class="wrap">
    <div class="row">
      <div class="brand"><div class="logo"></div> GAS Project Manager · Deep Ocean</div>
      <div class="spacer"></div>
      <div class="search" title="ค้นหา (Ctrl/Cmd + K)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="#9deaff" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23 6.5 6.5 0 1 0-6.5 6.5 6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM5 9.5A4.5 4.5 0 1 1 9.5 14 4.505 4.505 0 0 1 5 9.5z"/></svg>
        <input id="search" placeholder="ค้นหาชื่อหรือ ID…">
        <span class="kbd">Ctrl K</span>
      </div>
      <button class="btn secondary" id="btnRefresh">รีเฟรช</button>
      <button class="btn" id="btnCreate">สร้างโปรเจกต์ใหม่</button>
    </div>

    <div class="toolbar" style="margin-top:12px">
      <span class="chip"><input type="checkbox" id="filterStar"> เฉพาะติดดาว</span>
      <span class="chip"><input type="checkbox" id="includeShared"> รวม Shared Drives</span>
      <span class="chip"><input type="checkbox" id="perfMode"> โหมดประสิทธิภาพสูง</span>
      <span class="chip">
        เรียง: &nbsp;
        <select id="sort" style="background:transparent;border:0;color:var(--text);font-weight:800;outline:0">
          <option value="modifiedDate desc">แก้ไขล่าสุด</option>
          <option value="title">ชื่อ A → Z</option>
        </select>
      </span>
    </div>

    <div class="hero">
      <div class="wrap" style="padding:0">
        <div class="stats">
          <div class="stat"><div class="n" id="statTotal">0</div><div class="muted">ทั้งหมด (แสดงแล้ว)</div></div>
          <div class="stat"><div class="n" id="statStar">0</div><div class="muted">ติดดาว</div></div>
          <div class="stat"><div class="n" id="statRecent">0</div><div class="muted">อัปเดตใน 7 วัน</div></div>
          <div class="stat"><div class="n" id="statLoadedPage">0</div><div class="muted">เพจที่โหลด</div></div>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section id="grid" class="grid"></section>
    <div class="footer" id="footerLoadMore" style="display:none">
      <button class="btn" id="btnMore">โหลดเพิ่ม</button>
    </div>
  </div>
</main>

<!-- Command palette -->
<div id="palette" style="position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(2,8,15,.65);backdrop-filter:blur(6px);z-index:30">
  <div style="margin-top:8vh;background:linear-gradient(180deg, rgba(8,28,45,.95), rgba(8,28,45,.75));border:1px solid var(--border);border-radius:12px;min-width:320px;max-width:90vw;width:680px;box-shadow:var(--shadow)">
    <div style="display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--border)">
      <input id="palQuery" placeholder="พิมพ์เพื่อค้นหาโปรเจกต์… (Enter เพื่อเปิด)" style="flex:1;background:#0b2133;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px">
      <button class="btn secondary" id="palClose">ปิด</button>
    </div>
    <div id="palList" style="max-height:55vh;overflow:auto;padding:10px"></div>
  </div>
</div>

<!-- Modal สร้างโปรเจกต์ -->
<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,8,15,.65);backdrop-filter:blur(6px);z-index:40">
  <div style="background:linear-gradient(180deg, rgba(8,28,45,.95), rgba(8,28,45,.75));border:1px solid var(--border);border-radius:12px;min-width:320px;max-width:90vw;padding:16px;box-shadow:var(--shadow)">
    <h3 style="margin:0 0 10px 0">สร้างโปรเจกต์ใหม่</h3>
    <form id="formCreate">
      <div style="display:flex;gap:8px">
        <input id="projectName" placeholder="ระบุชื่อโปรเจกต์…" style="flex:1;background:#0b2133;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px">
        <button class="btn" type="submit">สร้าง</button>
        <button class="btn secondary" type="button" id="btnCancel">ยกเลิก</button>
      </div>
    </form>
    <p class="muted" style="margin-top:10px">ระบบจะเปิดแท็บแก้ไขสคริปต์ให้โดยอัตโนมัติเมื่อสร้างเสร็จ</p>
  </div>
</div>

<div class="statusbar"><div class="dot" id="netDot"></div><span id="netText" class="muted">พร้อม</span></div>
<div class="toast-wrap" id="toasts"></div>

<script>
(function(){
  'use strict';

  /** ====== ตั้งค่า URL ของ Apps Script Web App ====== */
  const GAS_API = 'https://script.google.com/macros/s/AKfycbznupKdv3Am76DteWc-PoZWJZ9QG9Ajw-Y7Ee6L4Cnn8uStnDPc3ZY3WIX9QaTe1LVh/exec'; // <- แทนที่ด้วยของจริง

  /** ====== ฟังก์ชันเรียก API ผ่าน fetch (แทน google.script.run) ====== */
  async function api(action, params = {}) {
    const url = new URL(GAS_API);
    url.searchParams.set('api', action);
    if (params.options && typeof params.options === 'object') {
      url.searchParams.set('options', JSON.stringify(params.options));
      const { options, ...rest } = params;
      params = rest;
    }
    for (const [k, v] of Object.entries(params)) {
      url.searchParams.set(k, v);
    }
    const res = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data && data.success === false && data.error) throw new Error(data.error);
    return data;
  }
  async function listProjectsClient(opts) { return api('list', { options: opts }); }
  async function getProjectDetailClient(id) { return api('detail', { id }); }
  async function toggleStarClient(id) { return api('star', { id }); }
  async function trashProjectClient(id) { return api('trash', { id }); }
  async function createNewProjectClient(name) { return api('create', { name }); }

  /** ====== UI FX (bubbles) ====== */
  const fx = document.getElementById('fx');
  const ctx = fx.getContext('2d');
  let W = fx.width = innerWidth, H = fx.height = innerHeight;
  const bubbles = [];
  function addBubble(){
    bubbles.push({
      x: Math.random()*W, y: H + Math.random()*H*.3,
      r: 2 + Math.random()*6,
      vy: 0.3 + Math.random()*0.8,
      sway: (Math.random()-.5)*0.6,
      alpha: 0.35 + Math.random()*0.4
    });
  }
  for(let i=0;i<120;i++) addBubble();
  addEventListener('resize', ()=>{ W=fx.width=innerWidth; H=fx.height=innerHeight; });
  function tick(){
    ctx.clearRect(0,0,W,H);
    for(const b of bubbles){
      b.y -= b.vy; b.x += Math.sin((b.y+b.r)/25)*b.sway;
      if (b.y < -20) { b.y = H + Math.random()*80; b.x = Math.random()*W; }
      ctx.beginPath();
      const g = ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
      g.addColorStop(0, `rgba(180,255,255,${b.alpha})`);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g; ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  /** ====== State & Elements ====== */
  const PAGE_SIZE  = 10; // ต่อหน้า
  const BATCH_SIZE = 3;  // micro-batch

  let items=[]; let view=[]; let nextPageToken=''; let loadedPages=0; let pending=0; let perfMode=false;

  const els = {
    grid: document.getElementById('grid'),
    btnMore: document.getElementById('btnMore'),
    footerMore: document.getElementById('footerLoadMore'),
    btnRefresh: document.getElementById('btnRefresh'),
    btnCreate: document.getElementById('btnCreate'),
    modal: document.getElementById('modal'),
    projectName: document.getElementById('projectName'),
    formCreate: document.getElementById('formCreate'),
    btnCancel: document.getElementById('btnCancel'),
    search: document.getElementById('search'),
    filterStar: document.getElementById('filterStar'),
    includeShared: document.getElementById('includeShared'),
    sort: document.getElementById('sort'),
    statTotal: document.getElementById('statTotal'),
    statStar: document.getElementById('statStar'),
    statRecent: document.getElementById('statRecent'),
    statLoadedPage: document.getElementById('statLoadedPage'),
    toasts: document.getElementById('toasts'),
    netDot: document.getElementById('netDot'),
    netText: document.getElementById('netText'),
    perfMode: document.getElementById('perfMode'),
    palette: document.getElementById('palette'),
    palQuery: document.getElementById('palQuery'),
    palList: document.getElementById('palList'),
    palClose: document.getElementById('palClose')
  };

  /** ====== Utils ====== */
  function toast(msg){
    const d=document.createElement('div');
    d.className='toast'; d.textContent=msg;
    els.toasts.appendChild(d); setTimeout(()=>d.remove(), 2600);
  }
  function fmtRelative(ms){
    if (!ms) return '';
    const diff = Date.now() - ms, day = 86400000;
    if (diff < 60*1000) return 'เมื่อสักครู่';
    if (diff < 60*60*1000) return Math.floor(diff/60000) + ' นาทีที่แล้ว';
    if (diff < 24*day) return Math.floor(diff/3600000) + ' ชั่วโมงที่แล้ว';
    if (diff < 7*day) return Math.floor(diff/day) + ' วันที่แล้ว';
    return new Date(ms).toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'});
  }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  function setNet(status){
    if (status==='busy'){ els.netDot.classList.add('on'); els.netText.textContent = 'กำลังโหลด…'; }
    else { els.netDot.classList.remove('on'); els.netText.textContent = 'พร้อม'; }
  }
  function setPerf(on){ perfMode=!!on; try{ localStorage.setItem('GAS_PM_PERF', on? '1':'0'); }catch(_){ } }

  /** ====== Stats ====== */
  function computeStats(){
    els.statTotal.textContent = items.length;
    els.statStar.textContent = items.filter(x=>x.starred).length;
    const weekAgo = Date.now() - 7*86400000;
    els.statRecent.textContent = items.filter(x=>x.modifiedTime > weekAgo).length;
    els.statLoadedPage.textContent = loadedPages;
  }

  /** ====== Cards ====== */
  function buildCard(p){
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="title">${esc(p.name)}</div>
      <div class="meta">
        <span class="tag">ID: ${p.id}</span>
        <span class="muted">อัปเดต: ${fmtRelative(p.modifiedTime)}</span>
        ${p.starred ? '<span class="tag star">★ Starred</span>' : ''}
      </div>
      <div class="actions">
        <button class="act primary" data-open="${p.url}">เปิด</button>
        <button class="act warn" data-detail="${p.id}">รายละเอียด</button>
        <button class="act" data-star="${p.id}">${p.starred ? 'ยกเลิกดาว' : 'ติดดาว'}</button>
        <button class="act danger" data-del="${p.id}">ลบ</button>
      </div>`;
    return card;
  }
  function renderAppendOne(p){ els.grid.appendChild(buildCard(p)); computeStats(); }

  /** ====== Filter ====== */
  function applyFilter(){
    const q = els.search.value.trim().toLowerCase();
    const starOnly = els.filterStar.checked;
    view = items.filter(x=>{
      if (starOnly && !x.starred) return false;
      if (!q) return true;
      return (x.name && x.name.toLowerCase().includes(q)) || (x.id && x.id.toLowerCase().includes(q));
    });
    els.grid.innerHTML = '';
    for (const p of view) renderAppendOne(p);
  }

  /** ====== Micro-batch loader ====== */
  function rpcList({reset=false}={}) {
    if (pending > 0) return;

    const base = {
      includeSharedDrives: els.includeShared.checked,
      starredOnly: els.filterStar.checked,
      sort: els.sort.value
    };

    let token = reset ? '' : nextPageToken;
    let fetched = 0;

    if (reset){
      items = []; view = []; els.grid.innerHTML = ''; els.footerMore.style.display = 'none';
      loadedPages = 0; computeStats();
    }

    pending++; els.btnMore.disabled = true; setNet('busy'); els.netText.textContent = `กำลังโหลด… 0/${PAGE_SIZE}`;

    async function step() {
      try {
        if (fetched >= PAGE_SIZE) {
          finalize();
          return;
        }
        const want = Math.min(BATCH_SIZE, PAGE_SIZE - fetched);
        const resp = await listProjectsClient(Object.assign({}, base, { pageToken: token, pageSize: want }));
        const files = (resp && resp.files) ? resp.files : [];
        token = (resp && resp.nextPageToken) || '';

        for (const f of files) {
          const idx = items.findIndex(x=>x.id===f.id);
          if (idx>=0) items[idx]=f; else items.push(f);
          renderAppendOne(f);
          fetched++;
          els.netText.textContent = `กำลังโหลด… ${fetched}/${PAGE_SIZE}`;
          if (fetched >= PAGE_SIZE) break;
        }

        if (fetched >= PAGE_SIZE || !token) {
          finalize();
          return;
        }
        await step();
      } catch (err) {
        pending--; if (pending<=0) setNet('idle'); els.btnMore.disabled=false;
        toast('โหลดข้อมูลล้มเหลว: ' + (err && err.message || ''));
      }
    }

    function finalize() {
      pending--; if (pending<=0) setNet('idle'); els.btnMore.disabled=false;
      nextPageToken = token || '';
      els.footerMore.style.display = nextPageToken ? 'flex' : 'none';
      if (fetched>0) loadedPages += 1;
      computeStats();
    }

    step();
  }

  /** ====== Grid actions ====== */
  async function onGridClick(e){
    const t = e.target; if (!(t instanceof HTMLElement)) return;

    const open = t.getAttribute('data-open');
    if (open){ wave(t,e); window.open(open, '_blank'); return; }

    const detailId = t.getAttribute('data-detail');
    if (detailId){
      wave(t,e);
      t.disabled = true; pending++; setNet('busy');
      try{
        const info = await getProjectDetailClient(detailId);
        alert(
          `ชื่อ: ${info.name}\n` +
          `เจ้าของ: ${info.owner || '-'}\n` +
          `สร้างเมื่อ: ${info.createdTime ? new Date(info.createdTime).toLocaleString('th-TH') : '-'}\n` +
          `แก้ไขล่าสุด: ${info.modifiedTime ? new Date(info.modifiedTime).toLocaleString('th-TH') : '-'}\n` +
          `ติดดาว: ${info.starred ? 'ใช่' : 'ไม่'}\n` +
          `ขนาด: ${info.size || 0}\n` +
          `ลิงก์: ${info.url}\n`
        );
      } catch(err){
        toast('ดึงรายละเอียดไม่สำเร็จ: ' + (err && err.message || ''));
      } finally {
        pending--; if (pending<=0) setNet('idle'); t.disabled=false;
      }
      return;
    }

    const starId = t.getAttribute('data-star');
    if (starId){
      wave(t,e);
      t.disabled = true; pending++; setNet('busy');
      try{
        const res = await toggleStarClient(starId);
        const idx = items.findIndex(x=>x.id===starId);
        if (idx>=0){ items[idx].starred = !!res.starred; }
        applyFilter();
        toast(res.message || 'อัพเดตสำเร็จ');
      } catch(err){
        toast('อัพเดตดาวไม่สำเร็จ: ' + (err && err.message || ''));
      } finally {
        pending--; if (pending<=0) setNet('idle'); t.disabled=false;
      }
      return;
    }

    const delId = t.getAttribute('data-del');
    if (delId){
      wave(t,e);
      if (!confirm('ย้ายโปรเจกต์นี้ลงถังขยะใช่หรือไม่?')) return;
      t.disabled = true; pending++; setNet('busy');
      try{
        const res = await trashProjectClient(delId);
        items = items.filter(x=>x.id!==delId);
        applyFilter();
        toast(res.message || 'ลบสำเร็จ');
      } catch(err){
        toast('ลบไม่สำเร็จ: ' + (err && err.message || ''));
      } finally {
        pending--; if (pending<=0) setNet('idle'); t.disabled=false;
      }
      return;
    }
  }

  /** ====== Ripple ====== */
  function wave(el, ev){
    const rect = el.getBoundingClientRect();
    const r = document.createElement('span');
    r.className='ripple';
    const size = Math.max(rect.width, rect.height);
    r.style.width = r.style.height = size + 'px';
    r.style.left = (ev.clientX - rect.left - size/2) + 'px';
    r.style.top  = (ev.clientY - rect.top  - size/2) + 'px';
    el.appendChild(r);
    setTimeout(()=> r.remove(), 650);
  }
  function bindRipples(){
    document.body.addEventListener('click', (e)=>{
      const t = e.target;
      if (t instanceof HTMLElement && (t.classList.contains('btn') || t.classList.contains('act'))) {
        wave(t, e);
      }
    });
  }

  /** ====== Palette ====== */
  function openPalette(){ els.palette.style.display='flex'; els.palQuery.value = els.search.value; renderPalette(); setTimeout(()=> els.palQuery.focus(), 0); }
  function closePalette(){ els.palette.style.display='none'; }
  function renderPalette(){
    const q = els.palQuery.value.trim().toLowerCase();
    const arr = items.filter(x=>{
      if (!q) return true;
      return (x.name && x.name.toLowerCase().includes(q)) || (x.id && x.id.toLowerCase().includes(q));
    }).slice(0, 50);
    const frag = document.createDocumentFragment();
    els.palList.innerHTML='';
    for (const p of arr){
      const row = document.createElement('div');
      row.className='card'; row.style.marginBottom = '8px';
      row.innerHTML = `
        <div class="title">${esc(p.name)}</div>
        <div class="meta"><span class="tag">ID: ${p.id}</span><span class="muted">อัปเดต: ${fmtRelative(p.modifiedTime)}</span></div>
        <div class="actions" style="margin-top:10px">
          <button class="act primary" data-open="${p.url}">เปิด</button>
          <button class="act" data-star="${p.id}">${p.starred ? 'ยกเลิกดาว':'ติดดาว'}</button>
        </div>`;
      frag.appendChild(row);
    }
    els.palList.appendChild(frag);
  }

  /** ====== Events ====== */
  els.grid.addEventListener('click', onGridClick);
  els.btnMore.onclick = ()=> rpcList({reset:false});
  els.btnRefresh.onclick = ()=> rpcList({reset:true});
  els.btnCreate.onclick = ()=>{ els.modal.style.display='flex'; setTimeout(()=>els.projectName.focus(),0); };
  els.btnCancel.onclick = ()=>{ els.modal.style.display='none'; els.projectName.value=''; };
  els.formCreate.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = (els.projectName.value || '').trim();
    if (!name){ toast('กรุณาระบุชื่อโปรเจกต์'); return; }
    els.projectName.disabled = true; pending++; setNet('busy');
    try{
      const res = await createNewProjectClient(name);
      els.modal.style.display='none'; els.projectName.value='';
      toast(res.message || 'สร้างสำเร็จ');
      rpcList({reset:true});
      setTimeout(()=> window.open(res.url, '_blank'), 600);
    } catch(err){
      toast('สร้างไม่สำเร็จ: ' + (err && err.message || ''));
    } finally {
      pending--; if (pending<=0) setNet('idle'); els.projectName.disabled=false;
    }
  });

  els.search.addEventListener('input', debounce(applyFilter, 160));
  els.filterStar.onchange = ()=> rpcList({reset:true});
  els.sort.onchange = ()=> rpcList({reset:true});
  els.includeShared.onchange = ()=> rpcList({reset:true});
  els.perfMode.onchange = ()=> setPerf(els.perfMode.checked);

  document.addEventListener('keydown', e=>{
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); openPalette(); }
    if (e.key==='Escape'){ closePalette(); els.modal.style.display='none'; }
  });
  els.palette.addEventListener('click', (e)=>{ if (e.target===els.palette) closePalette(); });
  els.palClose.onclick = closePalette;
  els.palQuery.addEventListener('input', debounce(renderPalette, 120));
  els.palList.addEventListener('click', async (e)=>{
    const t = e.target; if (!(t instanceof HTMLElement)) return;
    const open = t.getAttribute('data-open'); const star = t.getAttribute('data-star');
    if (open){ wave(t,e); window.open(open,'_blank'); }
    if (star){
      wave(t,e);
      try{
        const res = await toggleStarClient(star);
        const idx = items.findIndex(x=>x.id===star);
        if (idx>=0){ items[idx].starred = !!res.starred; }
        renderPalette(); applyFilter(); toast(res.message || 'อัพเดตสำเร็จ');
      } catch(err){
        toast('อัพเดตไม่สำเร็จ: ' + (err && err.message || ''));
      }
    }
  });

  bindRipples();

  // init
  try{ els.perfMode.checked = localStorage.getItem('GAS_PM_PERF')==='1'; setPerf(els.perfMode.checked); }catch(_){}
  rpcList({reset:true}); // start
})();
</script>
</body>
</html>
